<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Country API Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin-bottom: 20px; }
        button { padding: 5px 10px; margin: 5px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <div class="section">
        <h2>Register</h2>
        <input type="email" id="regEmail" placeholder="Email">
        <input type="password" id="regPassword" placeholder="Password">
        <input type="text" id="regFn" placeholder="First Name">
        <input type="text" id="regSn" placeholder="Last Name">
        <button onclick="register()">Register</button>
        <p id="regResult"></p>
    </div>

    <div class="section">
        <h2>Login</h2>
        <input type="email" id="loginEmail" placeholder="Email">
        <input type="password" id="loginPassword" placeholder="Password">
        <button onclick="login()">Login</button>
        <p id="loginResult"></p>
    </div>

    <div class="section" id="keySection" style="display: none;">
        <h2>API Key Management</h2>
        <button onclick="generateKey()">Generate New Key</button>
        <button onclick="fetchKeys()">Refresh Keys</button>
        <table id="keyTable">
            <thead>
                <tr><th>Key</th><th>Name</th><th>Created</th><th>Last Used</th><th>Usage Count</th><th>Action</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        async function register() {
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const fn = document.getElementById('regFn').value;
            const sn = document.getElementById('regSn').value;
            const response = await fetch('/registerUser', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password, fn, sn })
            });
            const result = await response.json();
            document.getElementById('regResult').textContent = result.success ? 'Registered!' : result.error;
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const response = await fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const result = await response.json();
            document.getElementById('loginResult').textContent = result.success ? 'Logged in!' : result.error;
            if (result.success) {
                document.getElementById('keySection').style.display = 'block';
                fetchKeys();
            }
        }

        async function generateKey() {
            const response = await fetch('/api/getapikey', { method: 'POST' });
            const result = await response.json();
            alert(result.success ? 'Key generated: ' + result.data.key : result.error);
            fetchKeys();
        }

        async function fetchKeys() {
            const response = await fetch('/api/keys');
            const result = await response.json();
            const tbody = document.getElementById('keyTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';
            if (result.success) {
                result.data.forEach(key => {
                    const row = tbody.insertRow();
                    row.insertCell().textContent = key.key;
                    row.insertCell().textContent = key.name;
                    row.insertCell().textContent = new Date(key.created_at).toLocaleString();
                    row.insertCell().textContent = key.last_used ? new Date(key.last_used).toLocaleString() : 'Never';
                    row.insertCell().textContent = key.usage_count;
                    const revokeBtn = document.createElement('button');
                    revokeBtn.textContent = 'Revoke';
                    revokeBtn.onclick = () => revokeKey(key.key);
                    row.insertCell().appendChild(revokeBtn);
                });
            }
        }

        async function revokeKey(key) {
            const response = await fetch(`/api/keys/${key}`, { method: 'DELETE' });
            const result = await response.json();
            alert(result.success ? 'Key revoked!' : result.error);
            fetchKeys();
        }
    </script>
</body>
</html>