<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, Helvetica, sans-serif; }
        * { box-sizing: border-box; }
        input[type=text], input[type=password], button {
            width: 100%; padding: 12px; border: 1px solid #ccc; margin-top: 6px; margin-bottom: 16px; resize: vertical;
        }
        button { background-color: #04AA6D; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #45a049; }
        .container { border-radius: 5px; background-color: #f2f2f2; padding: 10px; max-width: 600px; margin: 0 auto; }
        .column { float: left; width: 50%; margin-top: 6px; padding: 20px; }
        .row:after { content: ""; display: table; clear: both; }
        #apiKeyOutput, #keysList { margin-top: 20px; padding: 10px; background-color: #fff; border: 1px solid #ccc; }
        @media screen and (max-width: 600px) { .column, button { width: 100%; margin-top: 0; } }
    </style>
</head>
<body>
<h2>API Key Management</h2>
<p>Use this page to register, login, and manage API keys for the RestCountries API.</p>

<div class="container">
    <div style="text-align:center">
        <h2>Manage Your API Access</h2>
    </div>
    <div class="row">
        <div class="column">
            <form id="registerForm">
                <h3>Register</h3>
                <label for="email">Email</label>
                <input type="text" id="email" name="email" placeholder="Your email..">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" placeholder="Your password..">
                <label for="fn">First Name</label>
                <input type="text" id="fn" name="fn" placeholder="Your first name..">
                <label for="sn">Last Name</label>
                <input type="text" id="sn" name="sn" placeholder="Your last name..">
                <button type="submit">Register</button>
            </form>
        </div>
        <div class="column">
            <form id="loginForm">
                <h3>Login</h3>
                <label for="loginEmail">Email</label>
                <input type="text" id="loginEmail" name="email" placeholder="Your email..">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" name="password" placeholder="Your password..">
                <button type="submit">Login</button>
            </form>
            <div style="margin-top: 20px;">
                <button id="generateKeyBtn">Generate API Key</button>
                <button id="listKeysBtn">List My Keys</button>
                <div id="apiKeyOutput"></div>
                <div id="keysList"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // Register Form
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = {
            email: document.getElementById('email').value,
            password: document.getElementById('password').value,
            fn: document.getElementById('fn').value,
            sn: document.getElementById('sn').value
        };
        const response = await fetch('/registerUser', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        const result = await response.json();
        alert(result.success ? 'Registration successful!' : 'Error: ' + result.error);
    });

    // Login Form
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = {
            email: document.getElementById('loginEmail').value,
            password: document.getElementById('loginPassword').value
        };
        const response = await fetch('/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData),
            credentials: 'include'
        });
        const result = await response.json();
        alert(result.success ? 'Login successful!' : 'Error: ' + result.error);
    });

    // Generate API Key
    document.getElementById('generateKeyBtn').addEventListener('click', async () => {
        const response = await fetch('/getapikey', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include'
        });
        const result = await response.json();
        const output = document.getElementById('apiKeyOutput');
        output.style.display = 'block';
        output.textContent = result.success ? `Your API Key: ${result.data}` : `Error: ${result.error}`;
    });

    // List API Keys
    document.getElementById('listKeysBtn').addEventListener('click', async () => {
        const response = await fetch('/apikeys', {
            method: 'GET',
            credentials: 'include'
        });
        const result = await response.json();
        const keysList = document.getElementById('keysList');
        keysList.style.display = 'block';
        if (result.success) {
            keysList.innerHTML = '<h3>Your API Keys:</h3>' + result.data.map(key => 
                `<p>Key: ${key.key} | Active: ${key.is_active} | Usage: ${key.usage_count} | <button onclick="revokeKey('${key.key}')">Revoke</button></p>`
            ).join('');
        } else {
            keysList.textContent = `Error: ${result.error}`;
        }
    });

    // Revoke API Key
    async function revokeKey(key) {
        const response = await fetch('/revokeapikey', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ key }),
            credentials: 'include'
        });
        const result = await response.json();
        alert(result.success ? 'Key revoked!' : 'Error: ' + result.error);
        document.getElementById('listKeysBtn').click(); // Refresh list
    }
</script>
</body>
</html>